/*!
 * @name        jQuery PostcodeAnywhere
 * @author      Ifeanyi Isitor (ifeanyiisitor@gmail.com) <https://github.com/ifyio/jquery-postcode-lookup.git>
 * @modified    Saturday, June 29th, 2013, 10:14:21
 * @version     0.0.1
 */
!function(a){function b(){g(t),g(r),""==y.$postCode.val()&&h(s)}function c(a){r.html(a),f(r)}function d(b,c){var d;return b.find("option").each(function(){var b=a(this);return b.val()==c?(d=b,!1):void 0}),d}function e(a,b,d){g(r),j(a,d).findBy(b).then(function(b){if("error"==b.status.type)c(b.status.description);else{var d=k(a,b.addressCollection.currentLevel),e=d.adapt(b.addressCollection),f=l(a,b.addressCollection.currentLevel);f.handle(e)}})}function f(a){a.show()}function g(a){a.hide()}function h(a){a.attr("disabled","disabled")}function i(a){a.removeAttr("disabled")}function j(a,b){return m(a)[b].addressFinder(a)}function k(a,b){return m(a)[b].addressCollectionViewAdapter()}function l(a,b){return m(a)[b].addressViewHandler()}function m(a){return"GB"===a?A:B}function n(b,c){var d=new a.Deferred;return a.getJSON(b,c,function(a){var b={status:{type:"",message:""},addressCollection:{}};1==a.Items.length&&"undefined"!=typeof a.Items[0].Error?(b.status.type="error",b.status.message=a.Items[0].Description,b.status.description=a.Items[0].Cause,console.log(a.Items[0])):0==a.Items.length?(b.status.type="error",b.status.message="No addresses found",b.status.description=z.noAddressesFound):(b.status.type="success",b.addressCollection=a),d.resolve(b)}),d.promise()}function o(){return this.handle=function(a){t.empty(),p(a,v)},this}function p(b,c){var d=a("<select></select>");void 0!==c&&d.attr("size",c),d.addClass("pl-address-chooser").addClass(b.currentLevel).attr("name","address-chooser").data("country-code",b.countryCode).data("current-level",b.currentLevel).data("next-level",b.nextLevel).append(a("<option></option>").val("").html(b.firstOptionLabel)),a.each(b.Items,function(b,c){var e=a("<option></option>");e.val(c.id),e.html(c.label),e.data("stringified",c.stringified),e.data("test","yes"),d.append(e)}),t.append(d),f(t)}function q(){return this.handle=function(a){g(t),y.$street1.val(a.street1),y.$street2.val(a.street2),y.$street3.val(a.street3),y.$city.val(a.city),y.$county.val(a.county),y.$countryCode.val(a.countryCode),y.$postCode.val(a.postcode),t.empty()},this}var r=a(".pl-error-message"),s=a(".pl-find-postcode-button"),t=a(".pl-address-container"),u=a(".pl-init"),v=u.data("plAddressBoxSize"),w={},x={username:u.data("plUsername"),uk:{key:u.data("plUkApiKey"),url:{byPostcode:"http://services.postcodeanywhere.co.uk/PostcodeAnywhere/Interactive/FindByPostcode/v1.00/json3.ws?callback=?",byId:"http://services.postcodeanywhere.co.uk/PostcodeAnywhere/Interactive/RetrieveById/v1.30/json3.ws?callback=?"}},"int":{key:u.data("plIntApiKey"),url:{byPostcode:"http://services.postcodeanywhere.co.uk/PostcodeAnywhereInternational/Interactive/RetrieveByPostalCode/v2.20/json3.ws?callback=?",byStreet:"http://services.postcodeanywhere.co.uk/PostcodeAnywhereInternational/Interactive/ListBuildings/v1.20/json3.ws?callback=?"}}},y={$postCode:a(".pl-postcode"),$countryCode:a(".pl-country-code"),$street1:a(".pl-street1"),$street2:a(".pl-street2"),$street3:a(".pl-street3"),$city:a(".pl-city"),$county:a(".pl-county")},z={invalidCountry:u.data("plErrorInvalidCountry"),noAddressesFound:u.data("plErrorNoAddressesFound")};b(),y.$postCode.on("keyup",function(){y.$postCode.val()?i(s):h(s)}),s.on("click",function(a){a.preventDefault();var b=y.$countryCode.val(),d=y.$postCode.val(),f="first";b.length?e(b,d,f):c(z.invalidCountry)}),t.on("change",".pl-address-chooser",function(b){b.preventDefault();var c=a(this),f=c.val();if(void 0!==f&&null!==f&&f.length){var g=c.data("country-code"),h=c.data("next-level"),i=d(c,f);w[h]=JSON.parse(i.data("stringified")),e(g,f,h)}});var A={first:{addressFinder:function(){return this.findBy=function(b){var c=new a.Deferred;return n(x.uk.url.byPostcode,{Key:x.uk.key,Postcode:b,UserName:x.username}).then(function(a){a.addressCollection.countryCode="GB",a.addressCollection.currentLevel="first",a.addressCollection.nextLevel="final",c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=0,c=a.Items.length;for(b;c>b;b++){var d=a.Items[b];d.id=d.Id,d.label=d.StreetAddress,d.stringified=JSON.stringify(d)}return a.firstOptionLabel="Select your building and street",a},this},addressViewHandler:o},"final":{addressFinder:function(){return this.findBy=function(b){var c=new a.Deferred;return n(x.uk.url.byId,{Key:x.uk.key,Id:b,PreferredLanguage:"",UserName:x.username}).then(function(a){a.addressCollection.countryCode="GB",a.addressCollection.currentLevel="final",a.addressCollection.nextLevel="none",c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=a.Items[0];return a.street1=b.Company.length?b.Company+", "+b.Line1:b.Line1,a.street2=b.Line2,a.street3=b.Line3,a.city=b.PostTown,a.county=b.County,a.postcode=b.Postcode,a.countryName=b.CountryName,a.countryCode=b.CountryISO2,a},this},addressViewHandler:q}},B={first:{addressFinder:function(b){return this.findBy=function(c){var d=new a.Deferred;return n(x.int.url.byPostcode,{Key:x.int.key,Country:b,PostalCode:c,Building:-1}).then(function(a){a.addressCollection.countryCode=b,a.addressCollection.currentLevel="first",a.addressCollection.nextLevel="second",d.resolve(a)}),d.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(b){var c=[],d={firstOptionLabel:"Select your street",countryCode:b.countryCode,currentLevel:b.currentLevel,nextLevel:b.nextLevel};return a.each(b.Items,function(a,b){var d={id:b.StreetId,label:b.Description,stringified:JSON.stringify(b)};c.push(d)}),d.Items=c,d},this},addressViewHandler:o},second:{addressFinder:function(b){return this.findBy=function(c){var d=new a.Deferred;return n(x.int.url.byStreet,{Key:x.int.key,StreetId:c}).then(function(a){a.addressCollection.countryCode=b,a.addressCollection.currentLevel="second",a.addressCollection.nextLevel="final",d.resolve(a)}),d.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(b){var c=[],d={firstOptionLabel:"Select your building",countryCode:b.countryCode,currentLevel:b.currentLevel,nextLevel:b.nextLevel};return a.each(b.Items,function(a,b){var d={id:b.Building,label:b.Description,stringified:JSON.stringify(b)};c.push(d)}),d.Items=c,d},this},addressViewHandler:function(){return this.handle=function(a){p(a,v),t.find("select.first").attr("size",1)},this}},"final":{addressFinder:function(b){return this.findBy=function(){var c=new a.Deferred;return setTimeout(function(){var a={status:{type:"success",message:""},addressCollection:{countryCode:b,currentLevel:"final",nextLevel:"none",streetData:w.second,buildingData:w["final"]}};c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=a.streetData,c=a.buildingData;return a.street1=c.Description,a.street2="",a.street3="",a.city=b.City,a.county=b.State.length?b.State:b.District,a.postcode=b.PostalCode,a.countryName=b.Country,a},this},addressViewHandler:q}}}(jQuery);