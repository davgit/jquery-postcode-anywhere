/*!
 * @name        jQuery PostcodeAnywhere
 * @author      Ifeanyi Isitor (ifeanyiisitor@gmail.com) <https://github.com/ifyio/jquery-postcode-anywhere.git>
 * @modified    Tuesday, October 29th, 2013, 12:57:38
 * @version     0.1.1
 */
!function(a){var b={errorMessageContainer:".pl-error-message",errorMessageText:".pl-error-message-text",findPostcodeButton:".pl-find-postcode-button",addressResultsContainer:".pl-address-container",fieldClasses:{postcode:"pl-postcode",countryCode:"pl-country-code",street1:"pl-street1",street2:"pl-street2",street3:"pl-street3",city:"pl-city",county:"pl-county",addressSelector:"pl-address-chooser"}},c=function(c,d){function e(){Q.$countryCode.on("change",function(){var a=Q.$countryCode.val();a.length&&(void 0===H[a]?r(K):(q(K),l(R.countryRequired)&&m()))})}function f(){var a=Q.$countryCode.val();return a.length?!0:!1}function g(){var a=Q.$countryCode.val();return void 0===H[a]?!0:!1}function h(){for(var b in F.options.fieldClasses)Q["$"+b]=a("."+F.options.fieldClasses[b])}function i(a,b,c){m(),u(a,c).findBy(b).then(function(b){if("error"==b.status.type)o(b.status.description);else{var c=v(a,b.collection.currentLevel),d=c.adapt(b.collection),e=w(a,b.collection.currentLevel);e.handle(d)}})}function j(b){return this.contains=function(c){var d=!1;return a.each(b,function(a,b){return b==c?(d=!0,!1):void 0}),d},this}function k(){Q.$postcode.val()?t(K):s(K)}function l(a){return I.html()===a||J.html()===a}function m(){J.length?J.html(""):I.html(""),r(I)}function n(){r(L),r(I),""===Q.$postcode.val()&&s(K)}function o(a){J.length?J.html(a):I.html(a),q(I)}function p(b,c){var d;return b.find("option").each(function(){var b=a(this);return b.val()==c?(d=b,!1):void 0}),d}function q(a){a.show()}function r(a){a.hide()}function s(a){a.attr("disabled","disabled")}function t(a){a.removeAttr("disabled")}function u(a,b){return x(a)[b].addressFinder(a)}function v(a,b){return x(a)[b].addressCollectionViewAdapter()}function w(a,b){return x(a)[b].addressViewHandler()}function x(a){return"GB"===a?S:T}function y(b){var c=new a.Deferred;return A(P.int.url.listCountries,{Key:P.uk.key,Filter:b}).then(function(a){c.resolve(a)}),c.promise()}function z(b){var c={};return a.each(b,function(){var a=this;a.Postcodes&&(c[a.Iso2]={iso3:a.Iso3,name:a.Name})}),c}function A(b,c){var d=new a.Deferred;return a.getJSON(b,c,function(a){var b={status:{type:"",message:""},collection:{}};1==a.Items.length&&"undefined"!=typeof a.Items[0].Error?(b.status.type="error",b.status.code=a.Items[0].Error,b.status.message=a.Items[0].Description,b.status.nativeDescription=a.Items[0].Cause,b.status.description=j(O).contains(b.status.code)?R.serviceUnavailable:b.status.nativeDescription):0===a.Items.length?(b.status.type="error",b.status.message="No addresses found",b.status.description=R.noAddressesFound):(b.status.type="success",b.collection=a),d.resolve(b)}),d.promise()}function B(){return this.handle=function(a){a.Items.length>1?C().handle(a):E().handle(a)},this}function B(){return this.handle=function(a){a.Items.length>1?C().handle(a):E().handle(a)},this}function C(){return this.handle=function(a){L.empty(),D(a,M)},this}function D(b,c){var d=a("<select></select>");void 0!==c&&d.attr("size",c),d.addClass(F.options.fieldClasses.addressSelector).addClass(b.currentLevel).attr("name","address-chooser").data("country-code",b.countryCode).data("current-level",b.currentLevel).data("next-level",b.nextLevel).append(a("<option></option>").val("").html(b.firstOptionLabel)),a.each(b.Items,function(b,c){var e=a("<option></option>");e.val(c.id),e.html(c.label),e.data("stringified",c.stringified),e.data("test","yes"),d.append(e)}),L.children("select").eq(1).remove(),L.append(d),d.val(""),q(L)}function E(){return this.handle=function(b){r(L),Q.$street1.val(b.street1),Q.$street2.val(b.street2),Q.$street3.val(b.street3),Q.$city.val(b.city),Q.$countryCode.val(b.countryCode),Q.$postcode.val(b.postcode),a("."+F.options.fieldClasses.county).val(b.county),L.empty()},this}var F=this,G=a(c);this.options=a.extend({},b,d,G.data());var H,I=a(F.options.errorMessageContainer),J=I.find(F.options.errorMessageText),K=a(F.options.findPostcodeButton),L=a(F.options.addressResultsContainer),M=F.options.plAddressBoxSize,N={},O=[-1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16],P={username:F.options.plUsername,uk:{key:F.options.plUkApiKey,url:{byPostcode:"//services.postcodeanywhere.co.uk/PostcodeAnywhere/Interactive/FindByPostcode/v1.00/json3.ws?callback=?",byId:"//services.postcodeanywhere.co.uk/PostcodeAnywhere/Interactive/RetrieveById/v1.30/json3.ws?callback=?"}},"int":{key:F.options.plIntApiKey,url:{byPostcode:"//services.postcodeanywhere.co.uk/PostcodeAnywhereInternational/Interactive/RetrieveByPostalCode/v2.20/json3.ws?callback=?",byStreet:"//services.postcodeanywhere.co.uk/PostcodeAnywhereInternational/Interactive/ListBuildings/v1.20/json3.ws?callback=?",listCountries:"//services.postcodeanywhere.co.uk/Extras/Lists/CountryData/v2.00/json3.ws?callback=?"}}},Q={},R={countryRequired:F.options.plErrorCountryRequired,noAddressesFound:F.options.plErrorNoAddressesFound,serviceUnavailable:F.options.plErrorServiceUnavailable};h(),n(),e(),a.fn.postcodeAnywhere=function(b){if(n(),void 0!==b.fieldSelectors){for(var c in b.fieldSelectors)a(b.fieldSelectors[c]).addClass(F.options.fieldClasses[c]),Q["$"+c]=a("."+F.options.fieldClasses[c]);e()}return this},y().then(function(a){"error"!==a.status.type?(H=z(a.collection.Items),f()&&g()&&r(K)):o(a.status.description),setInterval(k,100)}),K.on("click",function(a){a.preventDefault();var b=Q.$countryCode.val(),c=Q.$postcode.val(),d="first";b.length?i(b,c,d):o(R.countryRequired)}),L.on("change","."+F.options.fieldClasses.addressSelector,function(b){b.preventDefault();var c=a(this),d=c.val();if(void 0!==d&&null!==d&&d.length){var e=c.data("country-code"),f=c.data("next-level"),g=p(c,d);N[f]=JSON.parse(g.data("stringified")),i(e,d,f)}});var S={first:{addressFinder:function(){return this.findBy=function(b){var c=new a.Deferred;return A(P.uk.url.byPostcode,{Key:P.uk.key,Postcode:b,UserName:P.username}).then(function(a){a.collection.countryCode="GB",a.collection.currentLevel="first",a.collection.nextLevel="final",c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=0,c=a.Items.length;for(b;c>b;b++){var d=a.Items[b];d.id=d.Id,d.label=d.StreetAddress,d.stringified=JSON.stringify(d)}return a.firstOptionLabel="Select your building and street",a},this},addressViewHandler:C},"final":{addressFinder:function(){return this.findBy=function(b){var c=new a.Deferred;return A(P.uk.url.byId,{Key:P.uk.key,Id:b,PreferredLanguage:"",UserName:P.username}).then(function(a){a.collection.countryCode="GB",a.collection.currentLevel="final",a.collection.nextLevel="none",c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=a.Items[0];return a.street1=b.Company.length?b.Company+", "+b.Line1:b.Line1,a.street2=b.Line2,a.street3=b.Line3,a.city=b.PostTown,a.county=b.County,a.postcode=b.Postcode,a.countryName=b.CountryName,a.countryCode=b.CountryISO2,a},this},addressViewHandler:E}},T={first:{addressFinder:function(b){return this.findBy=function(c){var d=new a.Deferred;return A(P.int.url.byPostcode,{Key:P.int.key,Country:b,PostalCode:c,Building:-1}).then(function(a){a.collection.countryCode=b,a.collection.currentLevel="first",a.collection.nextLevel="second",d.resolve(a)}),d.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(b){if(1===b.Items.length&&0===b.Items[0].Description.length){var c=b.Items[0];return b.street1=c.street,b.street2="",b.street3="",b.city=c.City,b.county=c.State.length?c.State:c.District,b.postcode=c.PostalCode,b.countryName=c.Country,b}var d=[],e={firstOptionLabel:"Select your street",countryCode:b.countryCode,currentLevel:b.currentLevel,nextLevel:b.nextLevel};return a.each(b.Items,function(a,b){var c={id:b.StreetId,label:b.Description,stringified:JSON.stringify(b)};d.push(c)}),e.Items=d,e},this},addressViewHandler:B},second:{addressFinder:function(b){return this.findBy=function(c){var d=new a.Deferred;return A(P.int.url.byStreet,{Key:P.int.key,StreetId:c}).then(function(a){a.collection.countryCode=b,a.collection.currentLevel="second",a.collection.nextLevel="final",d.resolve(a)}),d.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(b){var c=[],d={firstOptionLabel:"Select your building",countryCode:b.countryCode,currentLevel:b.currentLevel,nextLevel:b.nextLevel};return a.each(b.Items,function(a,b){var d={id:b.Building,label:b.Description,stringified:JSON.stringify(b)};c.push(d)}),d.Items=c,d},this},addressViewHandler:function(){return this.handle=function(a){D(a,M),L.find("select.first").attr("size",1)},this}},"final":{addressFinder:function(b){return this.findBy=function(){var c=new a.Deferred;return setTimeout(function(){var a={status:{type:"success",message:""},collection:{countryCode:b,currentLevel:"final",nextLevel:"none",streetData:N.second,buildingData:N["final"]}};c.resolve(a)}),c.promise()},this},addressCollectionViewAdapter:function(){return this.adapt=function(a){var b=a.streetData,c=a.buildingData;return a.street1=c.Description,a.street2="",a.street3="",a.city=b.City,a.county=b.State.length?b.State:b.District,a.postcode=b.PostalCode,a.countryName=b.Country,a},this},addressViewHandler:E}}},d="postcodeAnywhere";a.fn[d]=function(b){return this.each(function(){a.data(this,d)||a.data(this,d,new c(this,b))})},"function"==typeof define&&define.amd?define(function(){return c}):"undefined"!=typeof module&&module.exports&&(module.exports=c)}(jQuery),window.jQuery&&window.jQuery(function(){window.jQuery(".pl-init").postcodeAnywhere()});